/**
 * @fileoverview added by tsickle
 * Generated from: lib/cores/table-data-source.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __extends, __read, __values } from "tslib";
import { combineLatest, merge, Observable, of, ReplaySubject, Subscription } from 'rxjs';
import { map } from 'rxjs/operators';
import { MatTableDataSource } from '@angular/material/table';
import { titleCase } from '../utilies/text.utils';
/**
 * @template T
 */
var /**
 * @template T
 */
TableVirtualScrollDataSource = /** @class */ (function (_super) {
    __extends(TableVirtualScrollDataSource, _super);
    function TableVirtualScrollDataSource() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.filterMap = {};
        return _this;
    }
    Object.defineProperty(TableVirtualScrollDataSource.prototype, "allData", {
        get: /**
         * @return {?}
         */
        function () {
            return this.data;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype.toTranslate = /**
     * @return {?}
     */
    function () {
        var e_1, _a, e_2, _b;
        /** @type {?} */
        var tranList = [];
        /** @type {?} */
        var keys = Object.keys(this.filterMap);
        try {
            for (var keys_1 = __values(keys), keys_1_1 = keys_1.next(); !keys_1_1.done; keys_1_1 = keys_1.next()) {
                var k = keys_1_1.value;
                /** @type {?} */
                var fieldTotalTran = '';
                try {
                    for (var _c = (e_2 = void 0, __values(this.filterMap[k])), _d = _c.next(); !_d.done; _d = _c.next()) {
                        var f = _d.value;
                        fieldTotalTran += f.toPrint();
                    }
                }
                catch (e_2_1) { e_2 = { error: e_2_1 }; }
                finally {
                    try {
                        if (_d && !_d.done && (_b = _c.return)) _b.call(_c);
                    }
                    finally { if (e_2) throw e_2.error; }
                }
                if (fieldTotalTran !== '') {
                    tranList.push({ key: titleCase(k), value: fieldTotalTran });
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (keys_1_1 && !keys_1_1.done && (_a = keys_1.return)) _a.call(keys_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return tranList;
    };
    /**
     * @param {?} fieldName
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype.getFilter = /**
     * @param {?} fieldName
     * @return {?}
     */
    function (fieldName) {
        return this.filterMap[fieldName];
    };
    /**
     * @param {?} fieldName
     * @param {?} filters
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype.setFilter = /**
     * @param {?} fieldName
     * @param {?} filters
     * @return {?}
     */
    function (fieldName, filters) {
        var _this = this;
        this.filterMap[fieldName] = filters;
        return new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        function (subscriber) {
            setTimeout((/**
             * @return {?}
             */
            function () {
                _this.refreshFilterPredicate();
                subscriber.next();
                subscriber.complete();
            }), 200); // for show progress
        }));
    };
    /**
     * @param {?=} fieldName
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype.clearFilter = /**
     * @param {?=} fieldName
     * @return {?}
     */
    function (fieldName) {
        if (fieldName === void 0) { fieldName = null; }
        if (fieldName != null) {
            delete this.filterMap[fieldName];
        }
        else {
            this.filterMap = {};
        }
        this.refreshFilterPredicate();
    };
    /**
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype.clearData = /**
     * @return {?}
     */
    function () {
        this.data = [];
    };
    /**
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype.refreshFilterPredicate = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var conditionsString = '';
        Object.keys(this.filterMap).forEach((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            /** @type {?} */
            var fieldCondition = '';
            _this.filterMap[key].forEach((/**
             * @param {?} fieldFilter
             * @param {?} row
             * @param {?} array
             * @return {?}
             */
            function (fieldFilter, row, array) {
                if (row < array.length - 1) {
                    fieldCondition += fieldFilter.toString(key) + (fieldFilter.type === 'and' ? ' && ' : ' || ');
                }
                else {
                    fieldCondition += fieldFilter.toString(key);
                }
            }));
            if (fieldCondition !== '') {
                conditionsString += " " + (conditionsString === '' ? '' : ' && ') + " ( " + fieldCondition + " )";
            }
        }));
        if (conditionsString !== '') {
            /** @type {?} */
            var filterFunction_1 = new Function('_a$', 'return ' + conditionsString);
            this.filterPredicate = (/**
             * @param {?} data
             * @param {?} filter
             * @return {?}
             */
            function (data, filter) { return (/** @type {?} */ (filterFunction_1(data))); });
        }
        else {
            this.filterPredicate = (/**
             * @param {?} data
             * @param {?} filter
             * @return {?}
             */
            function (data, filter) { return true; });
        }
        this.filter = conditionsString;
    };
    // When client paging active use for reterive paging data
    // When client paging active use for reterive paging data
    /**
     * @param {?} data
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype.pagingData = 
    // When client paging active use for reterive paging data
    /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var p = ((/** @type {?} */ (this)))._paginator;
        if (p && p !== null) {
            /** @type {?} */
            var end = (p.pageIndex + 1) * p.pageSize;
            /** @type {?} */
            var start = p.pageIndex * p.pageSize;
            return data.slice(start, end);
        }
        return data;
    };
    /**
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype._updateChangeSubscription = /**
     * @return {?}
     */
    function () {
        var _this = this;
        var _a;
        this.initStreams();
        /** @type {?} */
        var sort = ((/** @type {?} */ (this)))._sort;
        /** @type {?} */
        var paginator = ((/** @type {?} */ (this)))._paginator;
        /** @type {?} */
        var internalPageChanges = ((/** @type {?} */ (this)))._internalPageChanges;
        /** @type {?} */
        var filter = ((/** @type {?} */ (this)))._filter;
        /** @type {?} */
        var renderData = ((/** @type {?} */ (this)))._renderData;
        /** @type {?} */
        var dataStream = ((/** @type {?} */ (this)))._data;
        /** @type {?} */
        var sortChange = sort ?
            (/** @type {?} */ (merge(sort.sortChange, sort.initialized))) : of(null);
        /** @type {?} */
        var pageChange = paginator ?
            (/** @type {?} */ (merge(paginator.page, internalPageChanges, paginator.initialized))) : of(null);
        // First Filter
        /** @type {?} */
        var filteredData = combineLatest([dataStream, filter]).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = __read(_a, 1), data = _b[0];
            return _this._filterData(data);
        })));
        // Second Order
        /** @type {?} */
        var orderedData = combineLatest([filteredData, sortChange]).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = __read(_a, 1), data = _b[0];
            return _this._orderData(data);
        })));
        // Last Paging
        /** @type {?} */
        var paginatedData = combineLatest([orderedData, pageChange]).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = __read(_a, 1), data = _b[0];
            return _this.pagingData(data);
        })));
        (_a = this._renderChangesSubscription) === null || _a === void 0 ? void 0 : _a.unsubscribe();
        this._renderChangesSubscription = new Subscription();
        this._renderChangesSubscription.add(paginatedData.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) { return _this.dataToRender$.next(data); })));
        this._renderChangesSubscription.add(this.dataOfRange$.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) { return renderData.next(data); })));
    };
    /**
     * @private
     * @return {?}
     */
    TableVirtualScrollDataSource.prototype.initStreams = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.streamsReady) {
            this.dataToRender$ = new ReplaySubject(1);
            this.dataOfRange$ = new ReplaySubject(1);
            this.streamsReady = true;
        }
    };
    return TableVirtualScrollDataSource;
}(MatTableDataSource));
/**
 * @template T
 */
export { TableVirtualScrollDataSource };
if (false) {
    /** @type {?} */
    TableVirtualScrollDataSource.prototype.dataToRender$;
    /** @type {?} */
    TableVirtualScrollDataSource.prototype.dataOfRange$;
    /**
     * @type {?}
     * @private
     */
    TableVirtualScrollDataSource.prototype.streamsReady;
    /**
     * @type {?}
     * @private
     */
    TableVirtualScrollDataSource.prototype.filterMap;
}
/**
 * @record
 * @template T
 */
export function HashMap() { }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtZGF0YS1zb3VyY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9keW5hbWljLW1hdC10YWJsZS8iLCJzb3VyY2VzIjpbImxpYi9jb3Jlcy90YWJsZS1kYXRhLXNvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBQW1CLGFBQWEsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQVcsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ILE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUk3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7Ozs7QUFFbEQ7Ozs7SUFBc0QsZ0RBQXFCO0lBQTNFO1FBQUEscUVBMEhDO1FBdEhTLGVBQVMsR0FBOEIsRUFBRSxDQUFDOztJQXNIcEQsQ0FBQztJQXBIQyxzQkFBSSxpREFBTzs7OztRQUFYO1lBQ0UsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ25CLENBQUM7OztPQUFBOzs7O0lBRUQsa0RBQVc7OztJQUFYOzs7WUFDUSxRQUFRLEdBQUcsRUFBRTs7WUFDYixJQUFJLEdBQWEsTUFBTSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUMsU0FBUyxDQUFFOztZQUNwRCxLQUFpQixJQUFBLFNBQUEsU0FBQSxJQUFJLENBQUEsMEJBQUEsNENBQUU7Z0JBQWpCLElBQU0sQ0FBQyxpQkFBQTs7b0JBQ1AsY0FBYyxHQUFHLEVBQUU7O29CQUN2QixLQUFpQixJQUFBLG9CQUFBLFNBQUEsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFBLGdCQUFBLDRCQUFFO3dCQUE5QixJQUFNLENBQUMsV0FBQTt3QkFDWCxjQUFjLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO3FCQUMvQjs7Ozs7Ozs7O2dCQUNELElBQUss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QywwQkFBMEIsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLFNBQVM7Ozs7UUFBQyxVQUFBLElBQUksSUFBSSxPQUFBLEtBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUE3QixDQUE2QixFQUFDLENBQUMsQ0FBQztRQUNwRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUzs7OztRQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBckIsQ0FBcUIsRUFBQyxDQUFDLENBQUM7SUFDbEcsQ0FBQzs7Ozs7SUFFTyxrREFBVzs7OztJQUFuQjtRQUNFLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxhQUFhLENBQU0sQ0FBQyxDQUFDLENBQUM7WUFDL0MsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLGFBQWEsQ0FBTSxDQUFDLENBQUMsQ0FBQztZQUM5QyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztTQUMxQjtJQUNILENBQUM7SUFDSCxtQ0FBQztBQUFELENBQUMsQUExSEQsQ0FBc0Qsa0JBQWtCLEdBMEh2RTs7Ozs7OztJQXpIQyxxREFBbUM7O0lBQ25DLG9EQUFrQzs7Ozs7SUFDbEMsb0RBQThCOzs7OztJQUM5QixpREFBa0Q7Ozs7OztBQXdIcEQsNkJBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIG1lcmdlLCBPYnNlcnZhYmxlLCBvZiwgUmVwbGF5U3ViamVjdCwgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTWF0VGFibGVEYXRhU291cmNlIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvdGFibGUnO1xyXG5pbXBvcnQgeyBNYXRTb3J0LCBTb3J0IH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvc29ydCc7XHJcbmltcG9ydCB7IE1hdFBhZ2luYXRvciwgUGFnZUV2ZW50IH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvcGFnaW5hdG9yJztcclxuaW1wb3J0IHsgQWJzdHJhY3RGaWx0ZXIgfSBmcm9tICcuLi9keW5hbWljLW1hdC10YWJsZS9leHRlbnNpb25zL2ZpbHRlci9jb21wYXJlL2Fic3RyYWN0LWZpbHRlcic7XHJcbmltcG9ydCB7IHRpdGxlQ2FzZSB9IGZyb20gJy4uL3V0aWxpZXMvdGV4dC51dGlscyc7XHJcblxyXG5leHBvcnQgIGNsYXNzIFRhYmxlVmlydHVhbFNjcm9sbERhdGFTb3VyY2U8VD4gZXh0ZW5kcyBNYXRUYWJsZURhdGFTb3VyY2U8VD4ge1xyXG4gIHB1YmxpYyBkYXRhVG9SZW5kZXIkOiBTdWJqZWN0PFRbXT47XHJcbiAgcHVibGljIGRhdGFPZlJhbmdlJDogU3ViamVjdDxUW10+O1xyXG4gIHByaXZhdGUgc3RyZWFtc1JlYWR5OiBib29sZWFuO1xyXG4gIHByaXZhdGUgZmlsdGVyTWFwOiBIYXNoTWFwPEFic3RyYWN0RmlsdGVyW10+ID0ge307XHJcblxyXG4gIGdldCBhbGxEYXRhKCk6IFRbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhO1xyXG4gIH1cclxuXHJcbiAgdG9UcmFuc2xhdGUoKTogYW55W10ge1xyXG4gICAgY29uc3QgdHJhbkxpc3QgPSBbXTtcclxuICAgIGNvbnN0IGtleXM6IHN0cmluZ1tdID0gT2JqZWN0LmtleXMoIHRoaXMuZmlsdGVyTWFwICk7XHJcbiAgICBmb3IgKCBjb25zdCBrIG9mIGtleXMpIHtcclxuICAgICAgbGV0IGZpZWxkVG90YWxUcmFuID0gJyc7XHJcbiAgICAgIGZvciAoIGNvbnN0IGYgb2YgdGhpcy5maWx0ZXJNYXBba10pIHtcclxuICAgICAgICBmaWVsZFRvdGFsVHJhbiArPSBmLnRvUHJpbnQoKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIGZpZWxkVG90YWxUcmFuICE9PSAnJykge1xyXG4gICAgICAgIHRyYW5MaXN0LnB1c2goIHsga2V5OiB0aXRsZUNhc2UoaykgLCB2YWx1ZTogZmllbGRUb3RhbFRyYW59ICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB0cmFuTGlzdDtcclxuICB9XHJcblxyXG4gIGdldEZpbHRlcihmaWVsZE5hbWU6IHN0cmluZyk6IEFic3RyYWN0RmlsdGVyW10ge1xyXG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyTWFwW2ZpZWxkTmFtZV07XHJcbiAgfVxyXG5cclxuICBzZXRGaWx0ZXIoZmllbGROYW1lOiBzdHJpbmcsIGZpbHRlcnM6IEFic3RyYWN0RmlsdGVyW10pOiBPYnNlcnZhYmxlPG51bGw+IHtcclxuICAgIHRoaXMuZmlsdGVyTWFwW2ZpZWxkTmFtZV0gPSBmaWx0ZXJzO1xyXG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKHN1YnNjcmliZXIgPT4ge1xyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICB0aGlzLnJlZnJlc2hGaWx0ZXJQcmVkaWNhdGUoKTtcclxuICAgICAgICBzdWJzY3JpYmVyLm5leHQoKTtcclxuICAgICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgIH0sIDIwMCk7IC8vIGZvciBzaG93IHByb2dyZXNzXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGNsZWFyRmlsdGVyKGZpZWxkTmFtZTogc3RyaW5nID0gbnVsbCkge1xyXG4gICAgaWYgKGZpZWxkTmFtZSAhPSBudWxsICkge1xyXG4gICAgICBkZWxldGUgdGhpcy5maWx0ZXJNYXBbZmllbGROYW1lXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZmlsdGVyTWFwID0ge307XHJcbiAgICB9XHJcbiAgICB0aGlzLnJlZnJlc2hGaWx0ZXJQcmVkaWNhdGUoKTtcclxuICB9XHJcblxyXG4gIGNsZWFyRGF0YSgpIHtcclxuICAgIHRoaXMuZGF0YSA9IFtdO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlZnJlc2hGaWx0ZXJQcmVkaWNhdGUoKSB7XHJcbiAgICBsZXQgY29uZGl0aW9uc1N0cmluZyA9ICcnO1xyXG4gICAgT2JqZWN0LmtleXModGhpcy5maWx0ZXJNYXApLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgbGV0IGZpZWxkQ29uZGl0aW9uID0gJyc7XHJcbiAgICAgIHRoaXMuZmlsdGVyTWFwW2tleV0uZm9yRWFjaCgoZmllbGRGaWx0ZXIsIHJvdywgYXJyYXkpID0+IHtcclxuICAgICAgICBpZiAocm93IDwgYXJyYXkubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgZmllbGRDb25kaXRpb24gKz0gZmllbGRGaWx0ZXIudG9TdHJpbmcoa2V5KSArIChmaWVsZEZpbHRlci50eXBlID09PSAnYW5kJyA/ICcgJiYgJyA6ICcgfHwgJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGZpZWxkQ29uZGl0aW9uICs9IGZpZWxkRmlsdGVyLnRvU3RyaW5nKGtleSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgaWYgKGZpZWxkQ29uZGl0aW9uICE9PSAnJykge1xyXG4gICAgICAgIGNvbmRpdGlvbnNTdHJpbmcgKz0gYCAke2NvbmRpdGlvbnNTdHJpbmcgPT09ICcnID8gJycgOiAnICYmICd9ICggJHtmaWVsZENvbmRpdGlvbn0gKWA7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgaWYgKGNvbmRpdGlvbnNTdHJpbmcgIT09ICcnKSB7XHJcbiAgICAgIGNvbnN0IGZpbHRlckZ1bmN0aW9uID0gbmV3IEZ1bmN0aW9uKCdfYSQnLCAncmV0dXJuICcgKyBjb25kaXRpb25zU3RyaW5nKTtcclxuICAgICAgdGhpcy5maWx0ZXJQcmVkaWNhdGUgPSAoZGF0YTogVCwgZmlsdGVyOiBzdHJpbmcpID0+IGZpbHRlckZ1bmN0aW9uKGRhdGEpIGFzIGJvb2xlYW47XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmZpbHRlclByZWRpY2F0ZSA9IChkYXRhOiBULCBmaWx0ZXI6IHN0cmluZykgPT4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHRoaXMuZmlsdGVyID0gY29uZGl0aW9uc1N0cmluZzsgICAgICAgIFxyXG4gIH1cclxuXHJcbiAgLy8gV2hlbiBjbGllbnQgcGFnaW5nIGFjdGl2ZSB1c2UgZm9yIHJldGVyaXZlIHBhZ2luZyBkYXRhXHJcbiAgcGFnaW5nRGF0YShkYXRhKSB7XHJcbiAgICBjb25zdCBwOiBNYXRQYWdpbmF0b3IgPSAodGhpcyBhcyBhbnkpLl9wYWdpbmF0b3I7XHJcbiAgICBpZiAoIHAgJiYgcCAhPT0gbnVsbCkge1xyXG4gICAgICBjb25zdCBlbmQgPSAocC5wYWdlSW5kZXggKyAxKSAqIHAucGFnZVNpemU7XHJcbiAgICAgIGNvbnN0IHN0YXJ0ID0gcC5wYWdlSW5kZXggKiBwLnBhZ2VTaXplO1xyXG4gICAgICByZXR1cm4gZGF0YS5zbGljZShzdGFydCwgZW5kKTtcclxuICAgIH1cclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH1cclxuXHJcbiAgX3VwZGF0ZUNoYW5nZVN1YnNjcmlwdGlvbigpIHtcclxuICAgIHRoaXMuaW5pdFN0cmVhbXMoKTtcclxuICAgIGNvbnN0IHNvcnQ6IE1hdFNvcnQgfCBudWxsID0gKHRoaXMgYXMgYW55KS5fc29ydDtcclxuICAgIGNvbnN0IHBhZ2luYXRvcjogTWF0UGFnaW5hdG9yIHwgbnVsbCA9ICh0aGlzIGFzIGFueSkuX3BhZ2luYXRvcjtcclxuICAgIGNvbnN0IGludGVybmFsUGFnZUNoYW5nZXM6IFN1YmplY3Q8dm9pZD4gPSAodGhpcyBhcyBhbnkpLl9pbnRlcm5hbFBhZ2VDaGFuZ2VzO1xyXG4gICAgY29uc3QgZmlsdGVyOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPiA9ICh0aGlzIGFzIGFueSkuX2ZpbHRlcjtcclxuICAgIGNvbnN0IHJlbmRlckRhdGE6IEJlaGF2aW9yU3ViamVjdDxUW10+ID0gKHRoaXMgYXMgYW55KS5fcmVuZGVyRGF0YTtcclxuICAgIGNvbnN0IGRhdGFTdHJlYW06IEJlaGF2aW9yU3ViamVjdDxUW10+ID0gKHRoaXMgYXMgYW55KS5fZGF0YTtcclxuXHJcbiAgICBjb25zdCBzb3J0Q2hhbmdlOiBPYnNlcnZhYmxlPFNvcnQgfCBudWxsIHwgdm9pZD4gPSBzb3J0ID9cclxuICAgICAgbWVyZ2Uoc29ydC5zb3J0Q2hhbmdlLCBzb3J0LmluaXRpYWxpemVkKSBhcyBPYnNlcnZhYmxlPFNvcnQgfCB2b2lkPiA6IG9mKG51bGwpO1xyXG4gICAgY29uc3QgcGFnZUNoYW5nZTogT2JzZXJ2YWJsZTxQYWdlRXZlbnQgfCBudWxsIHwgdm9pZD4gPSBwYWdpbmF0b3IgP1xyXG4gICAgICBtZXJnZShwYWdpbmF0b3IucGFnZSwgaW50ZXJuYWxQYWdlQ2hhbmdlcywgcGFnaW5hdG9yLmluaXRpYWxpemVkKSBhcyBPYnNlcnZhYmxlPFBhZ2VFdmVudCB8IHZvaWQ+IDogb2YobnVsbCk7XHJcblxyXG4gICAgLy8gRmlyc3QgRmlsdGVyXHJcbiAgICBjb25zdCBmaWx0ZXJlZERhdGEgPSBjb21iaW5lTGF0ZXN0KFtkYXRhU3RyZWFtLCBmaWx0ZXJdKS5waXBlKG1hcCgoW2RhdGFdKSA9PiB0aGlzLl9maWx0ZXJEYXRhKGRhdGEpKSk7XHJcbiAgICAvLyBTZWNvbmQgT3JkZXJcclxuICAgIGNvbnN0IG9yZGVyZWREYXRhID0gY29tYmluZUxhdGVzdChbZmlsdGVyZWREYXRhLCBzb3J0Q2hhbmdlXSkucGlwZShtYXAoKFtkYXRhXSkgPT4gdGhpcy5fb3JkZXJEYXRhKGRhdGEpKSk7XHJcbiAgICAvLyBMYXN0IFBhZ2luZ1xyXG4gICAgY29uc3QgcGFnaW5hdGVkRGF0YSA9IGNvbWJpbmVMYXRlc3QoW29yZGVyZWREYXRhLCBwYWdlQ2hhbmdlXSkucGlwZShtYXAoKFtkYXRhXSkgPT4gdGhpcy5wYWdpbmdEYXRhKGRhdGEpKSk7XHJcblxyXG4gICAgdGhpcy5fcmVuZGVyQ2hhbmdlc1N1YnNjcmlwdGlvbj8udW5zdWJzY3JpYmUoKTtcclxuICAgIHRoaXMuX3JlbmRlckNoYW5nZXNTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XHJcbiAgICB0aGlzLl9yZW5kZXJDaGFuZ2VzU3Vic2NyaXB0aW9uLmFkZChwYWdpbmF0ZWREYXRhLnN1YnNjcmliZShkYXRhID0+IHRoaXMuZGF0YVRvUmVuZGVyJC5uZXh0KGRhdGEpKSk7XHJcbiAgICB0aGlzLl9yZW5kZXJDaGFuZ2VzU3Vic2NyaXB0aW9uLmFkZCh0aGlzLmRhdGFPZlJhbmdlJC5zdWJzY3JpYmUoZGF0YSA9PiByZW5kZXJEYXRhLm5leHQoZGF0YSkpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdFN0cmVhbXMoKSB7XHJcbiAgICBpZiAoIXRoaXMuc3RyZWFtc1JlYWR5KSB7XHJcbiAgICAgIHRoaXMuZGF0YVRvUmVuZGVyJCA9IG5ldyBSZXBsYXlTdWJqZWN0PFRbXT4oMSk7XHJcbiAgICAgIHRoaXMuZGF0YU9mUmFuZ2UkID0gbmV3IFJlcGxheVN1YmplY3Q8VFtdPigxKTtcclxuICAgICAgdGhpcy5zdHJlYW1zUmVhZHkgPSB0cnVlO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBIYXNoTWFwPFQ+IHtcclxuICBba2V5OiBzdHJpbmddOiBUO1xyXG59XHJcbiJdfQ==