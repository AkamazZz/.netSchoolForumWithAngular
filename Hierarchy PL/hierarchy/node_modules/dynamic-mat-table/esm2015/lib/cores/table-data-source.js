/**
 * @fileoverview added by tsickle
 * Generated from: lib/cores/table-data-source.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { combineLatest, merge, Observable, of, ReplaySubject, Subscription } from 'rxjs';
import { map } from 'rxjs/operators';
import { MatTableDataSource } from '@angular/material/table';
import { titleCase } from '../utilies/text.utils';
/**
 * @template T
 */
export class TableVirtualScrollDataSource extends MatTableDataSource {
    constructor() {
        super(...arguments);
        this.filterMap = {};
    }
    /**
     * @return {?}
     */
    get allData() {
        return this.data;
    }
    /**
     * @return {?}
     */
    toTranslate() {
        /** @type {?} */
        const tranList = [];
        /** @type {?} */
        const keys = Object.keys(this.filterMap);
        for (const k of keys) {
            /** @type {?} */
            let fieldTotalTran = '';
            for (const f of this.filterMap[k]) {
                fieldTotalTran += f.toPrint();
            }
            if (fieldTotalTran !== '') {
                tranList.push({ key: titleCase(k), value: fieldTotalTran });
            }
        }
        return tranList;
    }
    /**
     * @param {?} fieldName
     * @return {?}
     */
    getFilter(fieldName) {
        return this.filterMap[fieldName];
    }
    /**
     * @param {?} fieldName
     * @param {?} filters
     * @return {?}
     */
    setFilter(fieldName, filters) {
        this.filterMap[fieldName] = filters;
        return new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        subscriber => {
            setTimeout((/**
             * @return {?}
             */
            () => {
                this.refreshFilterPredicate();
                subscriber.next();
                subscriber.complete();
            }), 200); // for show progress
        }));
    }
    /**
     * @param {?=} fieldName
     * @return {?}
     */
    clearFilter(fieldName = null) {
        if (fieldName != null) {
            delete this.filterMap[fieldName];
        }
        else {
            this.filterMap = {};
        }
        this.refreshFilterPredicate();
    }
    /**
     * @return {?}
     */
    clearData() {
        this.data = [];
    }
    /**
     * @return {?}
     */
    refreshFilterPredicate() {
        /** @type {?} */
        let conditionsString = '';
        Object.keys(this.filterMap).forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            /** @type {?} */
            let fieldCondition = '';
            this.filterMap[key].forEach((/**
             * @param {?} fieldFilter
             * @param {?} row
             * @param {?} array
             * @return {?}
             */
            (fieldFilter, row, array) => {
                if (row < array.length - 1) {
                    fieldCondition += fieldFilter.toString(key) + (fieldFilter.type === 'and' ? ' && ' : ' || ');
                }
                else {
                    fieldCondition += fieldFilter.toString(key);
                }
            }));
            if (fieldCondition !== '') {
                conditionsString += ` ${conditionsString === '' ? '' : ' && '} ( ${fieldCondition} )`;
            }
        }));
        if (conditionsString !== '') {
            /** @type {?} */
            const filterFunction = new Function('_a$', 'return ' + conditionsString);
            this.filterPredicate = (/**
             * @param {?} data
             * @param {?} filter
             * @return {?}
             */
            (data, filter) => (/** @type {?} */ (filterFunction(data))));
        }
        else {
            this.filterPredicate = (/**
             * @param {?} data
             * @param {?} filter
             * @return {?}
             */
            (data, filter) => true);
        }
        this.filter = conditionsString;
    }
    // When client paging active use for reterive paging data
    /**
     * @param {?} data
     * @return {?}
     */
    pagingData(data) {
        /** @type {?} */
        const p = ((/** @type {?} */ (this)))._paginator;
        if (p && p !== null) {
            /** @type {?} */
            const end = (p.pageIndex + 1) * p.pageSize;
            /** @type {?} */
            const start = p.pageIndex * p.pageSize;
            return data.slice(start, end);
        }
        return data;
    }
    /**
     * @return {?}
     */
    _updateChangeSubscription() {
        var _a;
        this.initStreams();
        /** @type {?} */
        const sort = ((/** @type {?} */ (this)))._sort;
        /** @type {?} */
        const paginator = ((/** @type {?} */ (this)))._paginator;
        /** @type {?} */
        const internalPageChanges = ((/** @type {?} */ (this)))._internalPageChanges;
        /** @type {?} */
        const filter = ((/** @type {?} */ (this)))._filter;
        /** @type {?} */
        const renderData = ((/** @type {?} */ (this)))._renderData;
        /** @type {?} */
        const dataStream = ((/** @type {?} */ (this)))._data;
        /** @type {?} */
        const sortChange = sort ?
            (/** @type {?} */ (merge(sort.sortChange, sort.initialized))) : of(null);
        /** @type {?} */
        const pageChange = paginator ?
            (/** @type {?} */ (merge(paginator.page, internalPageChanges, paginator.initialized))) : of(null);
        // First Filter
        /** @type {?} */
        const filteredData = combineLatest([dataStream, filter]).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        ([data]) => this._filterData(data))));
        // Second Order
        /** @type {?} */
        const orderedData = combineLatest([filteredData, sortChange]).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        ([data]) => this._orderData(data))));
        // Last Paging
        /** @type {?} */
        const paginatedData = combineLatest([orderedData, pageChange]).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        ([data]) => this.pagingData(data))));
        (_a = this._renderChangesSubscription) === null || _a === void 0 ? void 0 : _a.unsubscribe();
        this._renderChangesSubscription = new Subscription();
        this._renderChangesSubscription.add(paginatedData.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        data => this.dataToRender$.next(data))));
        this._renderChangesSubscription.add(this.dataOfRange$.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        data => renderData.next(data))));
    }
    /**
     * @private
     * @return {?}
     */
    initStreams() {
        if (!this.streamsReady) {
            this.dataToRender$ = new ReplaySubject(1);
            this.dataOfRange$ = new ReplaySubject(1);
            this.streamsReady = true;
        }
    }
}
if (false) {
    /** @type {?} */
    TableVirtualScrollDataSource.prototype.dataToRender$;
    /** @type {?} */
    TableVirtualScrollDataSource.prototype.dataOfRange$;
    /**
     * @type {?}
     * @private
     */
    TableVirtualScrollDataSource.prototype.streamsReady;
    /**
     * @type {?}
     * @private
     */
    TableVirtualScrollDataSource.prototype.filterMap;
}
/**
 * @record
 * @template T
 */
export function HashMap() { }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtZGF0YS1zb3VyY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9keW5hbWljLW1hdC10YWJsZS8iLCJzb3VyY2VzIjpbImxpYi9jb3Jlcy90YWJsZS1kYXRhLXNvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBbUIsYUFBYSxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLGFBQWEsRUFBVyxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbkgsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBSTdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQUVsRCxNQUFNLE9BQVEsNEJBQWdDLFNBQVEsa0JBQXFCO0lBQTNFOztRQUlVLGNBQVMsR0FBOEIsRUFBRSxDQUFDO0lBc0hwRCxDQUFDOzs7O0lBcEhDLElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDOzs7O0lBRUQsV0FBVzs7Y0FDSCxRQUFRLEdBQUcsRUFBRTs7Y0FDYixJQUFJLEdBQWEsTUFBTSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUMsU0FBUyxDQUFFO1FBQ3BELEtBQU0sTUFBTSxDQUFDLElBQUksSUFBSSxFQUFFOztnQkFDakIsY0FBYyxHQUFHLEVBQUU7WUFDdkIsS0FBTSxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNsQyxjQUFjLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO2FBQy9CO1lBQ0QsSUFBSyxjQUFjLEtBQUssRUFBRSxFQUFFO2dCQUMxQixRQUFRLENBQUMsSUFBSSxDQUFFLEVBQUUsR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRyxLQUFLLEVBQUUsY0FBYyxFQUFDLENBQUUs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QVc7UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLGFBQWEsQ0FBTSxDQUFDLENBQUMsQ0FBQztZQUMvQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksYUFBYSxDQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzlDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1NBQzFCO0lBQ0gsQ0FBQztDQUNGOzs7SUF6SEMscURBQW1DOztJQUNuQyxvREFBa0M7Ozs7O0lBQ2xDLG9EQUE4Qjs7Ozs7SUFDOUIsaURBQWtEOzs7Ozs7QUF3SHBELDZCQUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIFJlcGxheVN1YmplY3QsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE1hdFRhYmxlRGF0YVNvdXJjZSB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3RhYmxlJztcclxuaW1wb3J0IHsgTWF0U29ydCwgU29ydCB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3NvcnQnO1xyXG5pbXBvcnQgeyBNYXRQYWdpbmF0b3IsIFBhZ2VFdmVudCB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3BhZ2luYXRvcic7XHJcbmltcG9ydCB7IEFic3RyYWN0RmlsdGVyIH0gZnJvbSAnLi4vZHluYW1pYy1tYXQtdGFibGUvZXh0ZW5zaW9ucy9maWx0ZXIvY29tcGFyZS9hYnN0cmFjdC1maWx0ZXInO1xyXG5pbXBvcnQgeyB0aXRsZUNhc2UgfSBmcm9tICcuLi91dGlsaWVzL3RleHQudXRpbHMnO1xyXG5cclxuZXhwb3J0ICBjbGFzcyBUYWJsZVZpcnR1YWxTY3JvbGxEYXRhU291cmNlPFQ+IGV4dGVuZHMgTWF0VGFibGVEYXRhU291cmNlPFQ+IHtcclxuICBwdWJsaWMgZGF0YVRvUmVuZGVyJDogU3ViamVjdDxUW10+O1xyXG4gIHB1YmxpYyBkYXRhT2ZSYW5nZSQ6IFN1YmplY3Q8VFtdPjtcclxuICBwcml2YXRlIHN0cmVhbXNSZWFkeTogYm9vbGVhbjtcclxuICBwcml2YXRlIGZpbHRlck1hcDogSGFzaE1hcDxBYnN0cmFjdEZpbHRlcltdPiA9IHt9O1xyXG5cclxuICBnZXQgYWxsRGF0YSgpOiBUW10ge1xyXG4gICAgcmV0dXJuIHRoaXMuZGF0YTtcclxuICB9XHJcblxyXG4gIHRvVHJhbnNsYXRlKCk6IGFueVtdIHtcclxuICAgIGNvbnN0IHRyYW5MaXN0ID0gW107XHJcbiAgICBjb25zdCBrZXlzOiBzdHJpbmdbXSA9IE9iamVjdC5rZXlzKCB0aGlzLmZpbHRlck1hcCApO1xyXG4gICAgZm9yICggY29uc3QgayBvZiBrZXlzKSB7XHJcbiAgICAgIGxldCBmaWVsZFRvdGFsVHJhbiA9ICcnO1xyXG4gICAgICBmb3IgKCBjb25zdCBmIG9mIHRoaXMuZmlsdGVyTWFwW2tdKSB7XHJcbiAgICAgICAgZmllbGRUb3RhbFRyYW4gKz0gZi50b1ByaW50KCk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCBmaWVsZFRvdGFsVHJhbiAhPT0gJycpIHtcclxuICAgICAgICB0cmFuTGlzdC5wdXNoKCB7IGtleTogdGl0bGVDYXNlKGspICwgdmFsdWU6IGZpZWxkVG90YWxUcmFufSApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJhbkxpc3Q7XHJcbiAgfVxyXG5cclxuICBnZXRGaWx0ZXIoZmllbGROYW1lOiBzdHJpbmcpOiBBYnN0cmFjdEZpbHRlcltdIHtcclxuICAgIHJldHVybiB0aGlzLmZpbHRlck1hcFtmaWVsZE5hbWVdO1xyXG4gIH1cclxuXHJcbiAgc2V0RmlsdGVyKGZpZWxkTmFtZTogc3RyaW5nLCBmaWx0ZXJzOiBBYnN0cmFjdEZpbHRlcltdKTogT2JzZXJ2YWJsZTxudWxsPiB7XHJcbiAgICB0aGlzLmZpbHRlck1hcFtmaWVsZE5hbWVdID0gZmlsdGVycztcclxuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShzdWJzY3JpYmVyID0+IHtcclxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5yZWZyZXNoRmlsdGVyUHJlZGljYXRlKCk7XHJcbiAgICAgICAgc3Vic2NyaWJlci5uZXh0KCk7XHJcbiAgICAgICAgc3Vic2NyaWJlci5jb21wbGV0ZSgpO1xyXG4gICAgICB9LCAyMDApOyAvLyBmb3Igc2hvdyBwcm9ncmVzc1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBjbGVhckZpbHRlcihmaWVsZE5hbWU6IHN0cmluZyA9IG51bGwpIHtcclxuICAgIGlmIChmaWVsZE5hbWUgIT0gbnVsbCApIHtcclxuICAgICAgZGVsZXRlIHRoaXMuZmlsdGVyTWFwW2ZpZWxkTmFtZV07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmZpbHRlck1hcCA9IHt9O1xyXG4gICAgfVxyXG4gICAgdGhpcy5yZWZyZXNoRmlsdGVyUHJlZGljYXRlKCk7XHJcbiAgfVxyXG5cclxuICBjbGVhckRhdGEoKSB7XHJcbiAgICB0aGlzLmRhdGEgPSBbXTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZWZyZXNoRmlsdGVyUHJlZGljYXRlKCkge1xyXG4gICAgbGV0IGNvbmRpdGlvbnNTdHJpbmcgPSAnJztcclxuICAgIE9iamVjdC5rZXlzKHRoaXMuZmlsdGVyTWFwKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgIGxldCBmaWVsZENvbmRpdGlvbiA9ICcnO1xyXG4gICAgICB0aGlzLmZpbHRlck1hcFtrZXldLmZvckVhY2goKGZpZWxkRmlsdGVyLCByb3csIGFycmF5KSA9PiB7XHJcbiAgICAgICAgaWYgKHJvdyA8IGFycmF5Lmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgIGZpZWxkQ29uZGl0aW9uICs9IGZpZWxkRmlsdGVyLnRvU3RyaW5nKGtleSkgKyAoZmllbGRGaWx0ZXIudHlwZSA9PT0gJ2FuZCcgPyAnICYmICcgOiAnIHx8ICcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBmaWVsZENvbmRpdGlvbiArPSBmaWVsZEZpbHRlci50b1N0cmluZyhrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGlmIChmaWVsZENvbmRpdGlvbiAhPT0gJycpIHtcclxuICAgICAgICBjb25kaXRpb25zU3RyaW5nICs9IGAgJHtjb25kaXRpb25zU3RyaW5nID09PSAnJyA/ICcnIDogJyAmJiAnfSAoICR7ZmllbGRDb25kaXRpb259IClgO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIGlmIChjb25kaXRpb25zU3RyaW5nICE9PSAnJykge1xyXG4gICAgICBjb25zdCBmaWx0ZXJGdW5jdGlvbiA9IG5ldyBGdW5jdGlvbignX2EkJywgJ3JldHVybiAnICsgY29uZGl0aW9uc1N0cmluZyk7XHJcbiAgICAgIHRoaXMuZmlsdGVyUHJlZGljYXRlID0gKGRhdGE6IFQsIGZpbHRlcjogc3RyaW5nKSA9PiBmaWx0ZXJGdW5jdGlvbihkYXRhKSBhcyBib29sZWFuO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5maWx0ZXJQcmVkaWNhdGUgPSAoZGF0YTogVCwgZmlsdGVyOiBzdHJpbmcpID0+IHRydWU7XHJcbiAgICB9XHJcbiAgICB0aGlzLmZpbHRlciA9IGNvbmRpdGlvbnNTdHJpbmc7ICAgICAgICBcclxuICB9XHJcblxyXG4gIC8vIFdoZW4gY2xpZW50IHBhZ2luZyBhY3RpdmUgdXNlIGZvciByZXRlcml2ZSBwYWdpbmcgZGF0YVxyXG4gIHBhZ2luZ0RhdGEoZGF0YSkge1xyXG4gICAgY29uc3QgcDogTWF0UGFnaW5hdG9yID0gKHRoaXMgYXMgYW55KS5fcGFnaW5hdG9yO1xyXG4gICAgaWYgKCBwICYmIHAgIT09IG51bGwpIHtcclxuICAgICAgY29uc3QgZW5kID0gKHAucGFnZUluZGV4ICsgMSkgKiBwLnBhZ2VTaXplO1xyXG4gICAgICBjb25zdCBzdGFydCA9IHAucGFnZUluZGV4ICogcC5wYWdlU2l6ZTtcclxuICAgICAgcmV0dXJuIGRhdGEuc2xpY2Uoc3RhcnQsIGVuZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGF0YTtcclxuICB9XHJcblxyXG4gIF91cGRhdGVDaGFuZ2VTdWJzY3JpcHRpb24oKSB7XHJcbiAgICB0aGlzLmluaXRTdHJlYW1zKCk7XHJcbiAgICBjb25zdCBzb3J0OiBNYXRTb3J0IHwgbnVsbCA9ICh0aGlzIGFzIGFueSkuX3NvcnQ7XHJcbiAgICBjb25zdCBwYWdpbmF0b3I6IE1hdFBhZ2luYXRvciB8IG51bGwgPSAodGhpcyBhcyBhbnkpLl9wYWdpbmF0b3I7XHJcbiAgICBjb25zdCBpbnRlcm5hbFBhZ2VDaGFuZ2VzOiBTdWJqZWN0PHZvaWQ+ID0gKHRoaXMgYXMgYW55KS5faW50ZXJuYWxQYWdlQ2hhbmdlcztcclxuICAgIGNvbnN0IGZpbHRlcjogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4gPSAodGhpcyBhcyBhbnkpLl9maWx0ZXI7XHJcbiAgICBjb25zdCByZW5kZXJEYXRhOiBCZWhhdmlvclN1YmplY3Q8VFtdPiA9ICh0aGlzIGFzIGFueSkuX3JlbmRlckRhdGE7XHJcbiAgICBjb25zdCBkYXRhU3RyZWFtOiBCZWhhdmlvclN1YmplY3Q8VFtdPiA9ICh0aGlzIGFzIGFueSkuX2RhdGE7XHJcblxyXG4gICAgY29uc3Qgc29ydENoYW5nZTogT2JzZXJ2YWJsZTxTb3J0IHwgbnVsbCB8IHZvaWQ+ID0gc29ydCA/XHJcbiAgICAgIG1lcmdlKHNvcnQuc29ydENoYW5nZSwgc29ydC5pbml0aWFsaXplZCkgYXMgT2JzZXJ2YWJsZTxTb3J0IHwgdm9pZD4gOiBvZihudWxsKTtcclxuICAgIGNvbnN0IHBhZ2VDaGFuZ2U6IE9ic2VydmFibGU8UGFnZUV2ZW50IHwgbnVsbCB8IHZvaWQ+ID0gcGFnaW5hdG9yID9cclxuICAgICAgbWVyZ2UocGFnaW5hdG9yLnBhZ2UsIGludGVybmFsUGFnZUNoYW5nZXMsIHBhZ2luYXRvci5pbml0aWFsaXplZCkgYXMgT2JzZXJ2YWJsZTxQYWdlRXZlbnQgfCB2b2lkPiA6IG9mKG51bGwpO1xyXG5cclxuICAgIC8vIEZpcnN0IEZpbHRlclxyXG4gICAgY29uc3QgZmlsdGVyZWREYXRhID0gY29tYmluZUxhdGVzdChbZGF0YVN0cmVhbSwgZmlsdGVyXSkucGlwZShtYXAoKFtkYXRhXSkgPT4gdGhpcy5fZmlsdGVyRGF0YShkYXRhKSkpO1xyXG4gICAgLy8gU2Vjb25kIE9yZGVyXHJcbiAgICBjb25zdCBvcmRlcmVkRGF0YSA9IGNvbWJpbmVMYXRlc3QoW2ZpbHRlcmVkRGF0YSwgc29ydENoYW5nZV0pLnBpcGUobWFwKChbZGF0YV0pID0+IHRoaXMuX29yZGVyRGF0YShkYXRhKSkpO1xyXG4gICAgLy8gTGFzdCBQYWdpbmdcclxuICAgIGNvbnN0IHBhZ2luYXRlZERhdGEgPSBjb21iaW5lTGF0ZXN0KFtvcmRlcmVkRGF0YSwgcGFnZUNoYW5nZV0pLnBpcGUobWFwKChbZGF0YV0pID0+IHRoaXMucGFnaW5nRGF0YShkYXRhKSkpO1xyXG5cclxuICAgIHRoaXMuX3JlbmRlckNoYW5nZXNTdWJzY3JpcHRpb24/LnVuc3Vic2NyaWJlKCk7XHJcbiAgICB0aGlzLl9yZW5kZXJDaGFuZ2VzU3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xyXG4gICAgdGhpcy5fcmVuZGVyQ2hhbmdlc1N1YnNjcmlwdGlvbi5hZGQocGFnaW5hdGVkRGF0YS5zdWJzY3JpYmUoZGF0YSA9PiB0aGlzLmRhdGFUb1JlbmRlciQubmV4dChkYXRhKSkpO1xyXG4gICAgdGhpcy5fcmVuZGVyQ2hhbmdlc1N1YnNjcmlwdGlvbi5hZGQodGhpcy5kYXRhT2ZSYW5nZSQuc3Vic2NyaWJlKGRhdGEgPT4gcmVuZGVyRGF0YS5uZXh0KGRhdGEpKSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRTdHJlYW1zKCkge1xyXG4gICAgaWYgKCF0aGlzLnN0cmVhbXNSZWFkeSkge1xyXG4gICAgICB0aGlzLmRhdGFUb1JlbmRlciQgPSBuZXcgUmVwbGF5U3ViamVjdDxUW10+KDEpO1xyXG4gICAgICB0aGlzLmRhdGFPZlJhbmdlJCA9IG5ldyBSZXBsYXlTdWJqZWN0PFRbXT4oMSk7XHJcbiAgICAgIHRoaXMuc3RyZWFtc1JlYWR5ID0gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSGFzaE1hcDxUPiB7XHJcbiAgW2tleTogc3RyaW5nXTogVDtcclxufVxyXG4iXX0=