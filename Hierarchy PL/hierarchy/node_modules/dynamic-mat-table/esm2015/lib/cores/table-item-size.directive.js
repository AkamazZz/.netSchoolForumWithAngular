/**
 * @fileoverview added by tsickle
 * Generated from: lib/cores/table-item-size.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ContentChild, Directive, forwardRef, Input, NgZone } from '@angular/core';
import { VIRTUAL_SCROLL_STRATEGY } from '@angular/cdk/scrolling';
import { distinctUntilChanged, filter, map, switchMap, takeUntil, takeWhile, tap } from 'rxjs/operators';
import { TableVirtualScrollDataSource } from './table-data-source';
import { MatTable } from '@angular/material/table';
import { FixedSizeTableVirtualScrollStrategy } from './fixed-size-table-virtual-scroll-strategy';
import { Subject } from 'rxjs';
/**
 * @param {?} tableDir
 * @return {?}
 */
export function _tableVirtualScrollDirectiveStrategyFactory(tableDir) {
    return tableDir.scrollStrategy;
}
/** @type {?} */
const stickyHeaderSelector = '.mat-header-row .mat-table-sticky';
/** @type {?} */
const stickyFooterSelector = '.mat-footer-row .mat-table-sticky';
/** @type {?} */
const defaults = {
    rowHeight: 48,
    headerHeight: 56,
    headerEnabled: true,
    footerHeight: 48,
    footerEnabled: false,
    bufferMultiplier: 0.7
};
export class TableItemSizeDirective {
    /**
     * @param {?} zone
     */
    constructor(zone) {
        this.zone = zone;
        this.alive = true;
        // tslint:disable-next-line:no-input-rename
        this.rowHeight = defaults.rowHeight;
        this.headerEnabled = defaults.headerEnabled;
        this.headerHeight = defaults.headerHeight;
        this.footerEnabled = defaults.footerEnabled;
        this.footerHeight = defaults.footerHeight;
        this.bufferMultiplier = defaults.bufferMultiplier;
        // @Output() requestRendering: EventEmitter<any> = new EventEmitter();
        this.scrollStrategy = new FixedSizeTableVirtualScrollStrategy();
        this.dataSourceChanges = new Subject();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.alive = false;
        this.dataSourceChanges.complete();
    }
    /**
     * @private
     * @return {?}
     */
    isAlive() {
        return (/**
         * @return {?}
         */
        () => this.alive);
    }
    /**
     * @private
     * @return {?}
     */
    isStickyEnabled() {
        return !!this.scrollStrategy.viewport && ((/** @type {?} */ (((/** @type {?} */ (this.table)))._headerRowDefs)))
            .map((/**
         * @param {?} def
         * @return {?}
         */
        def => def.sticky))
            .reduce((/**
         * @param {?} prevState
         * @param {?} state
         * @return {?}
         */
        (prevState, state) => prevState && state), true);
    }
    /**
     * @return {?}
     */
    ngAfterContentInit() {
        /** @type {?} */
        const switchDataSourceOrigin = ((/** @type {?} */ (this.table)))._switchDataSource;
        ((/** @type {?} */ (this.table)))._switchDataSource = (/**
         * @param {?} dataSource
         * @return {?}
         */
        (dataSource) => {
            switchDataSourceOrigin.call(this.table, dataSource);
            this.connectDataSource(dataSource);
        });
        this.connectDataSource(this.table.dataSource);
        this.scrollStrategy.stickyChange
            .pipe(filter((/**
         * @return {?}
         */
        () => this.isStickyEnabled())), tap((/**
         * @return {?}
         */
        () => {
            if (!this.stickyPositions) {
                this.initStickyPositions();
            }
        })), takeWhile(this.isAlive()))
            .subscribe((/**
         * @param {?} stickyOffset
         * @return {?}
         */
        (stickyOffset) => {
            this.setSticky(stickyOffset);
        }));
    }
    /**
     * @param {?} dataSource
     * @return {?}
     */
    connectDataSource(dataSource) {
        this.dataSourceChanges.next();
        if (dataSource instanceof TableVirtualScrollDataSource) {
            dataSource
                .dataToRender$
                .pipe(distinctUntilChanged(), takeUntil(this.dataSourceChanges), takeWhile(this.isAlive()), tap((/**
             * @param {?} data
             * @return {?}
             */
            data => this.scrollStrategy.dataLength = data.length)), switchMap((/**
             * @param {?} data
             * @return {?}
             */
            data => this.scrollStrategy
                .renderedRangeStream
                .pipe(map((/**
             * @param {?} __0
             * @return {?}
             */
            ({ start, end }) => {
                // this.requestRendering.emit({from: start, to: end});
                return typeof start !== 'number' || typeof end !== 'number' ? data : data.slice(start, end);
            }))))))
                .subscribe((/**
             * @param {?} data
             * @return {?}
             */
            data => {
                this.zone.run((/**
                 * @return {?}
                 */
                () => {
                    dataSource.dataOfRange$.next(data);
                }));
            }));
        }
        else {
            throw new Error('[tvsItemSize] requires TableVirtualScrollDataSource be set as [dataSource] of [mat-table]');
        }
    }
    /**
     * @return {?}
     */
    ngOnChanges() {
        /** @type {?} */
        const config = {
            rowHeight: +this.rowHeight || defaults.rowHeight,
            headerHeight: this.headerEnabled ? +this.headerHeight || defaults.headerHeight : 0,
            footerHeight: this.footerEnabled ? +this.footerHeight || defaults.footerHeight : 0,
            bufferMultiplier: +this.bufferMultiplier || defaults.bufferMultiplier
        };
        this.scrollStrategy.setConfig(config);
    }
    // setSticky(offset) {
    //   // fixed bug when sticky true for header and one column. column scroll front of header. becuse of z-index
    //   let topOffset = -offset;
    //   this.scrollStrategy.viewport.elementRef.nativeElement.querySelectorAll('mat-header-row.mat-table-sticky')
    //     .forEach((el: HTMLElement) => {
    //       el.style.top = `${topOffset}px`;
    //       topOffset += el.offsetHeight;
    //       if (el.style.zIndex !== null ) {
    //         el.style.zIndex = '1000';
    //       }
    //     });
    // }
    /**
     * @param {?} offset
     * @return {?}
     */
    setSticky(offset) {
        this.scrollStrategy.viewport.elementRef.nativeElement.querySelectorAll(stickyHeaderSelector)
            .forEach((/**
         * @param {?} el
         * @return {?}
         */
        (el) => {
            /** @type {?} */
            const parent = el.parentElement;
            /** @type {?} */
            let baseOffset = 0;
            if (this.stickyPositions.has(parent)) {
                baseOffset = this.stickyPositions.get(parent);
            }
            el.style.top = `${baseOffset - offset}px`;
        }));
        this.scrollStrategy.viewport.elementRef.nativeElement.querySelectorAll(stickyFooterSelector)
            .forEach((/**
         * @param {?} el
         * @return {?}
         */
        (el) => {
            /** @type {?} */
            const parent = el.parentElement;
            /** @type {?} */
            let baseOffset = 0;
            if (this.stickyPositions.has(parent)) {
                baseOffset = this.stickyPositions.get(parent);
            }
            el.style.bottom = `${-baseOffset + offset}px`;
        }));
    }
    /**
     * @private
     * @return {?}
     */
    initStickyPositions() {
        this.stickyPositions = new Map();
        this.scrollStrategy.viewport.elementRef.nativeElement.querySelectorAll(stickyHeaderSelector)
            .forEach((/**
         * @param {?} el
         * @return {?}
         */
        el => {
            /** @type {?} */
            const parent = el.parentElement;
            if (!this.stickyPositions.has(parent)) {
                this.stickyPositions.set(parent, parent.offsetTop);
            }
        }));
    }
}
TableItemSizeDirective.decorators = [
    { type: Directive, args: [{
                // tslint:disable-next-line:directive-selector
                selector: 'cdk-virtual-scroll-viewport[tvsItemSize]',
                providers: [{
                        provide: VIRTUAL_SCROLL_STRATEGY,
                        useFactory: _tableVirtualScrollDirectiveStrategyFactory,
                        deps: [forwardRef((/**
                             * @return {?}
                             */
                            () => TableItemSizeDirective))]
                    }]
            },] }
];
/** @nocollapse */
TableItemSizeDirective.ctorParameters = () => [
    { type: NgZone }
];
TableItemSizeDirective.propDecorators = {
    rowHeight: [{ type: Input, args: ['tvsItemSize',] }],
    headerEnabled: [{ type: Input }],
    headerHeight: [{ type: Input }],
    footerEnabled: [{ type: Input }],
    footerHeight: [{ type: Input }],
    bufferMultiplier: [{ type: Input }],
    table: [{ type: ContentChild, args: [MatTable, { static: true },] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    TableItemSizeDirective.prototype.alive;
    /** @type {?} */
    TableItemSizeDirective.prototype.rowHeight;
    /** @type {?} */
    TableItemSizeDirective.prototype.headerEnabled;
    /** @type {?} */
    TableItemSizeDirective.prototype.headerHeight;
    /** @type {?} */
    TableItemSizeDirective.prototype.footerEnabled;
    /** @type {?} */
    TableItemSizeDirective.prototype.footerHeight;
    /** @type {?} */
    TableItemSizeDirective.prototype.bufferMultiplier;
    /** @type {?} */
    TableItemSizeDirective.prototype.table;
    /** @type {?} */
    TableItemSizeDirective.prototype.scrollStrategy;
    /** @type {?} */
    TableItemSizeDirective.prototype.dataSourceChanges;
    /**
     * @type {?}
     * @private
     */
    TableItemSizeDirective.prototype.stickyPositions;
    /**
     * @type {?}
     * @private
     */
    TableItemSizeDirective.prototype.zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtaXRlbS1zaXplLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2R5bmFtaWMtbWF0LXRhYmxlLyIsInNvdXJjZXMiOlsibGliL2NvcmVzL3RhYmxlLWl0ZW0tc2l6ZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQW9CLFlBQVksRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUNyRCxLQUFLLEVBQUUsTUFBTSxFQUE4QyxNQUFNLGVBQWUsQ0FBQztBQUMxRixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RyxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLG1DQUFtQyxFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFFakcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7Ozs7QUFHL0IsTUFBTSxVQUFVLDJDQUEyQyxDQUFDLFFBQWdDO0lBQzFGLE9BQU8sUUFBUSxDQUFDLGNBQWMsQ0FBQztBQUNqQyxDQUFDOztNQUVLLG9CQUFvQixHQUFHLG1DQUFtQzs7TUFDMUQsb0JBQW9CLEdBQUcsbUNBQW1DOztNQUUxRCxRQUFRLEdBQUc7SUFDZixTQUFTLEVBQUUsRUFBRTtJQUNiLFlBQVksRUFBRSxFQUFFO0lBQ2hCLGFBQWEsRUFBRSxJQUFJO0lBQ25CLFlBQVksRUFBRSxFQUFFO0lBQ2hCLGFBQWEsRUFBRSxLQUFLO0lBQ3BCLGdCQUFnQixFQUFFLEdBQUc7Q0FDdEI7QUFXRCxNQUFNLE9BQU8sc0JBQXNCOzs7O0lBK0JqQyxZQUFvQixJQUFZ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SUFFckMsa0RBQzZDOztJQUU3Qyx1Q0FBK0Q7O0lBSS9ELGdEQUEyRDs7SUFFM0QsbURBQXdDOzs7OztJQUN4QyxpREFBa0Q7Ozs7O0lBRXRDLHNDQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyQ29udGVudEluaXQsIENvbnRlbnRDaGlsZCwgRGlyZWN0aXZlLCBmb3J3YXJkUmVmLFxyXG4gICAgICAgICBJbnB1dCwgTmdab25lLCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgT3V0cHV0LCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVklSVFVBTF9TQ1JPTExfU1RSQVRFR1kgfSBmcm9tICdAYW5ndWxhci9jZGsvc2Nyb2xsaW5nJztcclxuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIGZpbHRlciwgbWFwLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgdGFrZVdoaWxlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFRhYmxlVmlydHVhbFNjcm9sbERhdGFTb3VyY2UgfSBmcm9tICcuL3RhYmxlLWRhdGEtc291cmNlJztcclxuaW1wb3J0IHsgTWF0VGFibGUgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC90YWJsZSc7XHJcbmltcG9ydCB7IEZpeGVkU2l6ZVRhYmxlVmlydHVhbFNjcm9sbFN0cmF0ZWd5IH0gZnJvbSAnLi9maXhlZC1zaXplLXRhYmxlLXZpcnR1YWwtc2Nyb2xsLXN0cmF0ZWd5JztcclxuaW1wb3J0IHsgQ2RrSGVhZGVyUm93RGVmIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3RhYmxlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfdGFibGVWaXJ0dWFsU2Nyb2xsRGlyZWN0aXZlU3RyYXRlZ3lGYWN0b3J5KHRhYmxlRGlyOiBUYWJsZUl0ZW1TaXplRGlyZWN0aXZlKSB7XHJcbiAgcmV0dXJuIHRhYmxlRGlyLnNjcm9sbFN0cmF0ZWd5O1xyXG59XHJcblxyXG5jb25zdCBzdGlja3lIZWFkZXJTZWxlY3RvciA9ICcubWF0LWhlYWRlci1yb3cgLm1hdC10YWJsZS1zdGlja3knO1xyXG5jb25zdCBzdGlja3lGb290ZXJTZWxlY3RvciA9ICcubWF0LWZvb3Rlci1yb3cgLm1hdC10YWJsZS1zdGlja3knO1xyXG5cclxuY29uc3QgZGVmYXVsdHMgPSB7XHJcbiAgcm93SGVpZ2h0OiA0OCxcclxuICBoZWFkZXJIZWlnaHQ6IDU2LFxyXG4gIGhlYWRlckVuYWJsZWQ6IHRydWUsXHJcbiAgZm9vdGVySGVpZ2h0OiA0OCxcclxuICBmb290ZXJFbmFibGVkOiBmYWxzZSxcclxuICBidWZmZXJNdWx0aXBsaWVyOiAwLjdcclxufTtcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3JcclxuICBzZWxlY3RvcjogJ2Nkay12aXJ0dWFsLXNjcm9sbC12aWV3cG9ydFt0dnNJdGVtU2l6ZV0nLFxyXG4gIHByb3ZpZGVyczogW3tcclxuICAgIHByb3ZpZGU6IFZJUlRVQUxfU0NST0xMX1NUUkFURUdZLFxyXG4gICAgdXNlRmFjdG9yeTogX3RhYmxlVmlydHVhbFNjcm9sbERpcmVjdGl2ZVN0cmF0ZWd5RmFjdG9yeSxcclxuICAgIGRlcHM6IFtmb3J3YXJkUmVmKCgpID0+IFRhYmxlSXRlbVNpemVEaXJlY3RpdmUpXVxyXG4gIH1dXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUYWJsZUl0ZW1TaXplRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzLCBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgYWxpdmUgPSB0cnVlO1xyXG5cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8taW5wdXQtcmVuYW1lXHJcbiAgQElucHV0KCd0dnNJdGVtU2l6ZScpXHJcbiAgcm93SGVpZ2h0ID0gZGVmYXVsdHMucm93SGVpZ2h0O1xyXG5cclxuICBASW5wdXQoKVxyXG4gIGhlYWRlckVuYWJsZWQgPSBkZWZhdWx0cy5oZWFkZXJFbmFibGVkO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIGhlYWRlckhlaWdodCA9IGRlZmF1bHRzLmhlYWRlckhlaWdodDtcclxuXHJcbiAgQElucHV0KClcclxuICBmb290ZXJFbmFibGVkID0gZGVmYXVsdHMuZm9vdGVyRW5hYmxlZDtcclxuXHJcbiAgQElucHV0KClcclxuICBmb290ZXJIZWlnaHQgPSBkZWZhdWx0cy5mb290ZXJIZWlnaHQ7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgYnVmZmVyTXVsdGlwbGllciA9IGRlZmF1bHRzLmJ1ZmZlck11bHRpcGxpZXI7XHJcblxyXG4gIEBDb250ZW50Q2hpbGQoTWF0VGFibGUsIHsgc3RhdGljOiB0cnVlIH0pIHRhYmxlOiBNYXRUYWJsZTxhbnk+O1xyXG5cclxuICAvLyBAT3V0cHV0KCkgcmVxdWVzdFJlbmRlcmluZzogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcblxyXG4gIHNjcm9sbFN0cmF0ZWd5ID0gbmV3IEZpeGVkU2l6ZVRhYmxlVmlydHVhbFNjcm9sbFN0cmF0ZWd5KCk7XHJcblxyXG4gIGRhdGFTb3VyY2VDaGFuZ2VzID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuICBwcml2YXRlIHN0aWNreVBvc2l0aW9uczogTWFwPEhUTUxFbGVtZW50LCBudW1iZXI+O1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHpvbmU6IE5nWm9uZSkge1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLmFsaXZlID0gZmFsc2U7XHJcbiAgICB0aGlzLmRhdGFTb3VyY2VDaGFuZ2VzLmNvbXBsZXRlKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzQWxpdmUoKSB7XHJcbiAgICByZXR1cm4gKCkgPT4gdGhpcy5hbGl2ZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNTdGlja3lFbmFibGVkKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICEhdGhpcy5zY3JvbGxTdHJhdGVneS52aWV3cG9ydCAmJiAoKHRoaXMudGFibGUgYXMgYW55KS5faGVhZGVyUm93RGVmcyBhcyBDZGtIZWFkZXJSb3dEZWZbXSlcclxuICAgICAgLm1hcChkZWYgPT4gZGVmLnN0aWNreSlcclxuICAgICAgLnJlZHVjZSgocHJldlN0YXRlLCBzdGF0ZSkgPT4gcHJldlN0YXRlICYmIHN0YXRlLCB0cnVlKTtcclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcclxuICAgIGNvbnN0IHN3aXRjaERhdGFTb3VyY2VPcmlnaW4gPSAodGhpcy50YWJsZSBhcyBhbnkpLl9zd2l0Y2hEYXRhU291cmNlO1xyXG4gICAgKHRoaXMudGFibGUgYXMgYW55KS5fc3dpdGNoRGF0YVNvdXJjZSA9IChkYXRhU291cmNlOiBhbnkpID0+IHtcclxuICAgICAgc3dpdGNoRGF0YVNvdXJjZU9yaWdpbi5jYWxsKHRoaXMudGFibGUsIGRhdGFTb3VyY2UpO1xyXG4gICAgICB0aGlzLmNvbm5lY3REYXRhU291cmNlKGRhdGFTb3VyY2UpO1xyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLmNvbm5lY3REYXRhU291cmNlKHRoaXMudGFibGUuZGF0YVNvdXJjZSk7XHJcblxyXG4gICAgdGhpcy5zY3JvbGxTdHJhdGVneS5zdGlja3lDaGFuZ2VcclxuICAgICAgLnBpcGUoXHJcbiAgICAgICAgZmlsdGVyKCgpID0+IHRoaXMuaXNTdGlja3lFbmFibGVkKCkpLFxyXG4gICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIXRoaXMuc3RpY2t5UG9zaXRpb25zKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdFN0aWNreVBvc2l0aW9ucygpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHRha2VXaGlsZSh0aGlzLmlzQWxpdmUoKSlcclxuICAgICAgKVxyXG4gICAgICAuc3Vic2NyaWJlKChzdGlja3lPZmZzZXQpID0+IHtcclxuICAgICAgICB0aGlzLnNldFN0aWNreShzdGlja3lPZmZzZXQpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIGNvbm5lY3REYXRhU291cmNlKGRhdGFTb3VyY2U6IGFueSkge1xyXG4gICAgICB0aGlzLmRhdGFTb3VyY2VDaGFuZ2VzLm5leHQoKTtcclxuICAgICAgaWYgKGRhdGFTb3VyY2UgaW5zdGFuY2VvZiBUYWJsZVZpcnR1YWxTY3JvbGxEYXRhU291cmNlKSB7XHJcbiAgICAgICAgZGF0YVNvdXJjZVxyXG4gICAgICAgICAgLmRhdGFUb1JlbmRlciRcclxuICAgICAgICAgIC5waXBlKFxyXG4gICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxyXG4gICAgICAgICAgICB0YWtlVW50aWwodGhpcy5kYXRhU291cmNlQ2hhbmdlcyksXHJcbiAgICAgICAgICAgIHRha2VXaGlsZSh0aGlzLmlzQWxpdmUoKSksXHJcbiAgICAgICAgICAgIHRhcChkYXRhID0+IHRoaXMuc2Nyb2xsU3RyYXRlZ3kuZGF0YUxlbmd0aCA9IGRhdGEubGVuZ3RoKSxcclxuICAgICAgICAgICAgc3dpdGNoTWFwKGRhdGEgPT5cclxuICAgICAgICAgICAgICB0aGlzLnNjcm9sbFN0cmF0ZWd5XHJcbiAgICAgICAgICAgICAgICAucmVuZGVyZWRSYW5nZVN0cmVhbVxyXG4gICAgICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICBtYXAoKHsgc3RhcnQsIGVuZCB9KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5yZXF1ZXN0UmVuZGVyaW5nLmVtaXQoe2Zyb206IHN0YXJ0LCB0bzogZW5kfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBzdGFydCAhPT0gJ251bWJlcicgfHwgdHlwZW9mIGVuZCAhPT0gJ251bWJlcicgPyBkYXRhIDogZGF0YS5zbGljZShzdGFydCwgZW5kKTtcclxuICAgICAgICAgICAgICAgICAgIH0pICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgIClcclxuICAgICAgICAgIC5zdWJzY3JpYmUoZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgIGRhdGFTb3VyY2UuZGF0YU9mUmFuZ2UkLm5leHQoZGF0YSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbdHZzSXRlbVNpemVdIHJlcXVpcmVzIFRhYmxlVmlydHVhbFNjcm9sbERhdGFTb3VyY2UgYmUgc2V0IGFzIFtkYXRhU291cmNlXSBvZiBbbWF0LXRhYmxlXScpO1xyXG4gICAgICB9ICAgIFxyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoKSB7XHJcbiAgICBjb25zdCBjb25maWcgPSB7XHJcbiAgICAgIHJvd0hlaWdodDogK3RoaXMucm93SGVpZ2h0IHx8IGRlZmF1bHRzLnJvd0hlaWdodCxcclxuICAgICAgaGVhZGVySGVpZ2h0OiB0aGlzLmhlYWRlckVuYWJsZWQgPyArdGhpcy5oZWFkZXJIZWlnaHQgfHwgZGVmYXVsdHMuaGVhZGVySGVpZ2h0IDogMCxcclxuICAgICAgZm9vdGVySGVpZ2h0OiB0aGlzLmZvb3RlckVuYWJsZWQgPyArdGhpcy5mb290ZXJIZWlnaHQgfHwgZGVmYXVsdHMuZm9vdGVySGVpZ2h0IDogMCxcclxuICAgICAgYnVmZmVyTXVsdGlwbGllcjogK3RoaXMuYnVmZmVyTXVsdGlwbGllciB8fCBkZWZhdWx0cy5idWZmZXJNdWx0aXBsaWVyXHJcbiAgICB9O1xyXG4gICAgdGhpcy5zY3JvbGxTdHJhdGVneS5zZXRDb25maWcoY29uZmlnKTtcclxuICB9XHJcblxyXG5cclxuICAvLyBzZXRTdGlja3kob2Zmc2V0KSB7XHJcbiAgLy8gICAvLyBmaXhlZCBidWcgd2hlbiBzdGlja3kgdHJ1ZSBmb3IgaGVhZGVyIGFuZCBvbmUgY29sdW1uLiBjb2x1bW4gc2Nyb2xsIGZyb250IG9mIGhlYWRlci4gYmVjdXNlIG9mIHotaW5kZXhcclxuICAvLyAgIGxldCB0b3BPZmZzZXQgPSAtb2Zmc2V0O1xyXG4gIC8vICAgdGhpcy5zY3JvbGxTdHJhdGVneS52aWV3cG9ydC5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnbWF0LWhlYWRlci1yb3cubWF0LXRhYmxlLXN0aWNreScpXHJcbiAgLy8gICAgIC5mb3JFYWNoKChlbDogSFRNTEVsZW1lbnQpID0+IHtcclxuICAvLyAgICAgICBlbC5zdHlsZS50b3AgPSBgJHt0b3BPZmZzZXR9cHhgO1xyXG4gIC8vICAgICAgIHRvcE9mZnNldCArPSBlbC5vZmZzZXRIZWlnaHQ7XHJcbiAgLy8gICAgICAgaWYgKGVsLnN0eWxlLnpJbmRleCAhPT0gbnVsbCApIHtcclxuICAvLyAgICAgICAgIGVsLnN0eWxlLnpJbmRleCA9ICcxMDAwJztcclxuICAvLyAgICAgICB9XHJcbiAgLy8gICAgIH0pO1xyXG4gIC8vIH1cclxuXHJcbiAgc2V0U3RpY2t5KG9mZnNldCkge1xyXG4gICAgdGhpcy5zY3JvbGxTdHJhdGVneS52aWV3cG9ydC5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzdGlja3lIZWFkZXJTZWxlY3RvcilcclxuICAgICAgLmZvckVhY2goKGVsOiBIVE1MRWxlbWVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhcmVudCA9IGVsLnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgICAgbGV0IGJhc2VPZmZzZXQgPSAwO1xyXG4gICAgICAgIGlmICh0aGlzLnN0aWNreVBvc2l0aW9ucy5oYXMocGFyZW50KSkge1xyXG4gICAgICAgICAgYmFzZU9mZnNldCA9IHRoaXMuc3RpY2t5UG9zaXRpb25zLmdldChwYXJlbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbC5zdHlsZS50b3AgPSBgJHtiYXNlT2Zmc2V0IC0gb2Zmc2V0fXB4YDtcclxuICAgICAgfSk7XHJcbiAgICB0aGlzLnNjcm9sbFN0cmF0ZWd5LnZpZXdwb3J0LmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHN0aWNreUZvb3RlclNlbGVjdG9yKVxyXG4gICAgICAuZm9yRWFjaCgoZWw6IEhUTUxFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGFyZW50ID0gZWwucGFyZW50RWxlbWVudDtcclxuICAgICAgICBsZXQgYmFzZU9mZnNldCA9IDA7XHJcbiAgICAgICAgaWYgKHRoaXMuc3RpY2t5UG9zaXRpb25zLmhhcyhwYXJlbnQpKSB7XHJcbiAgICAgICAgICBiYXNlT2Zmc2V0ID0gdGhpcy5zdGlja3lQb3NpdGlvbnMuZ2V0KHBhcmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsLnN0eWxlLmJvdHRvbSA9IGAkey1iYXNlT2Zmc2V0ICsgb2Zmc2V0fXB4YDtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRTdGlja3lQb3NpdGlvbnMoKSB7XHJcbiAgICB0aGlzLnN0aWNreVBvc2l0aW9ucyA9IG5ldyBNYXA8SFRNTEVsZW1lbnQsIG51bWJlcj4oKTtcclxuICAgIHRoaXMuc2Nyb2xsU3RyYXRlZ3kudmlld3BvcnQuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc3RpY2t5SGVhZGVyU2VsZWN0b3IpXHJcbiAgICAgIC5mb3JFYWNoKGVsID0+IHtcclxuICAgICAgICBjb25zdCBwYXJlbnQgPSBlbC5wYXJlbnRFbGVtZW50O1xyXG4gICAgICAgIGlmICghdGhpcy5zdGlja3lQb3NpdGlvbnMuaGFzKHBhcmVudCkpIHtcclxuICAgICAgICAgIHRoaXMuc3RpY2t5UG9zaXRpb25zLnNldChwYXJlbnQsIHBhcmVudC5vZmZzZXRUb3ApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==